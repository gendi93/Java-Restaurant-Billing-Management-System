package application;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.Writer;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.time.LocalDateTime;

import javafx.beans.property.ReadOnlyObjectWrapper;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.event.EventHandler;
import javafx.fxml.FXML;
import javafx.scene.control.Button;
import javafx.scene.control.ComboBox;
import javafx.scene.control.Label;
import javafx.scene.control.TableCell;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableColumn.CellEditEvent;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.control.cell.TextFieldTableCell;
import javafx.scene.layout.AnchorPane;

public class OrderController {
	@FXML
	private TableView order;
	@FXML
	private Label orderNumber;
	@FXML
	private Label totalPrice;
	@FXML
	private Label tableNumber;
	@FXML
	private TextField commentBox;
	@FXML
	private AnchorPane main;
	@FXML
	private ComboBox comboBoxItems;

	static int itemIndex = -1;
	static int orderItemIndex;
	static ObservableList<OrderItem> newData = FXCollections.observableArrayList();
	static ObservableList<OrderItem> newerData = FXCollections.observableArrayList();
	static ObservableList<Item> importedData = FXCollections.observableArrayList();
	static ObservableList<String> importedItemStrings = FXCollections.observableArrayList();
	static ObservableList<Order> orders = FXCollections.observableArrayList();

	public void getItems() {
		try {
			BufferedReader in = new BufferedReader(new FileReader("C:\\Users\\GENDI\\Desktop\\Shit.csv"));
			String dataLine;
			importedData.clear();
			importedItemStrings.clear();
			while ((dataLine = in.readLine()) != null) {
				for (int i = 0; i < 3; i += 3) {
					String[] dataValues = dataLine.split(",");
					importedData.add(new Item(dataValues[i], dataValues[i + 1], dataValues[i + 2]));
				}
			}
			in.close();
		} catch (Exception e) {
		} finally {
			for (Item i : importedData) {
				importedItemStrings.add(i.getItem());
			}
		}
	}

	public void readOrder(int tableNum) {
		getItems();
		comboBoxItems.getItems().clear();
		comboBoxItems.getItems().addAll(importedItemStrings);
		Boolean orderExists = false;
		int orderIndex = -1;
		for (Order o : orders) {
			if (o.getTableNumber() == tableNum) {
				orderExists = true;
				orderIndex = orders.indexOf(o);
			}
		}
		if (!orderExists) {
			try {
				application.Main.numberOfOrder++;
				String s = "C:\\Users\\GENDI\\Desktop\\";
				String stamp = "Order " + String.valueOf(application.Main.numberOfOrder);
				File dir = new File(s);
				dir.mkdirs();
				String file = dir + "\\" + stamp + ".csv";
				LocalDateTime currentTime = LocalDateTime.now();
				int hour = currentTime.getHour();
				int minute = currentTime.getMinute();
				int second = currentTime.getSecond();
				String orderTime = (hour + ":" + minute + ":" + second);
				orders.add(new Order(file, orderTime, tableNum));
				File permfile = new File(dir, stamp + ".csv");
				permfile.createNewFile();
				orderNumber.setText("# " + String.valueOf(application.Main.numberOfOrder));
				tableNumber.setText("Table: " + tableNum);
				totalPrice.setText("0.0");
			} catch (Exception e) {
			}
		} else {
			try {
				String tableLabel = tableNumber.getText();
				String[] tableArray = tableLabel.split("Table: ");
				String file = "";
				for (Order o : orders) {
					if (o.getTableNumber() == tableNum) {
						file = o.getFile();
					}
				}
				BufferedReader in = new BufferedReader(new FileReader(file));
				String dataLine;
				newData.clear();
				newerData.clear();
				while ((dataLine = in.readLine()) != null) {
					for (int i = 0; i < 3; i += 4) {
						String[] dataValues = dataLine.split(",");
						newData.add(
								new OrderItem(dataValues[i], dataValues[i + 1], dataValues[i + 2], dataValues[i + 3]));
					}
				}
				in.close();
			} catch (Exception e) {
			} finally {
				populateOrder(newData);
			}
		}
	}

	public void populateOrder(ObservableList<OrderItem> orderData) {
		order.setEditable(true);

		TableColumn orderItemCol = new TableColumn("Item");
		orderItemCol.setMinWidth(100);
		orderItemCol.setCellValueFactory(new PropertyValueFactory<OrderItem, String>("orderItem"));
		orderItemCol.setCellFactory(TextFieldTableCell.forTableColumn());
		orderItemCol.setEditable(false);

		TableColumn quantityCol = new TableColumn("Quantity");
		quantityCol.setMinWidth(60);
		quantityCol.setCellValueFactory(new PropertyValueFactory<OrderItem, String>("quantity"));
		quantityCol.setCellFactory(TextFieldTableCell.forTableColumn());
		quantityCol.setOnEditCommit(new EventHandler<CellEditEvent<OrderItem, String>>() {
			public void handle(CellEditEvent<OrderItem, String> t) {
				OrderItem orderItem = (OrderItem) t.getTableView().getItems().get(t.getTablePosition().getRow());
				double oldPrice = Double.parseDouble(orderItem.getPrice()) * Integer.parseInt(orderItem.getQuantity());
				orderItem.setQuantity(t.getNewValue());
				double newPrice = Double.parseDouble(orderItem.getPrice()) * Integer.parseInt(orderItem.getQuantity());
				totalPrice.setText(String.valueOf(Double.parseDouble(totalPrice.getText()) - oldPrice + newPrice));
				try {
					String tableLabel = tableNumber.getText();
					String[] tableArray = tableLabel.split("Table: ");
					int tableNum = Integer.parseInt(tableArray[1]);
					String file = "";
					for (Order o : orders) {
						if (o.getTableNumber() == tableNum) {
							file = o.getFile();
						}
					}
					writeOrder(file);
				} catch (Exception e) {
				}
			}
		});

		TableColumn commentCol = new TableColumn("Special Request");
		commentCol.setMinWidth(260);
		commentCol.setCellValueFactory(new PropertyValueFactory<OrderItem, String>("comment"));
		commentCol.setCellFactory(TextFieldTableCell.forTableColumn());
		commentCol.setOnEditCommit(new EventHandler<CellEditEvent<OrderItem, String>>() {
			public void handle(CellEditEvent<OrderItem, String> t) {
				((OrderItem) t.getTableView().getItems().get(t.getTablePosition().getRow()))
						.setComment(t.getNewValue());
				try {
					String tableLabel = tableNumber.getText();
					String[] tableArray = tableLabel.split("Table: ");
					int tableNum = Integer.parseInt(tableArray[1]);
					String file = "";
					for (Order o : orders) {
						if (o.getTableNumber() == tableNum) {
							file = o.getFile();
						}
					}
					writeOrder(file);
				} catch (Exception e) {
				}
			}
		});

		TableColumn priceCol = new TableColumn("Price");
		priceCol.setMinWidth(45);
		priceCol.setCellValueFactory(new PropertyValueFactory<OrderItem, String>("price"));
		priceCol.setCellFactory(TextFieldTableCell.forTableColumn());
		priceCol.setEditable(false);

		TableColumn<OrderItem, OrderItem> deleteCol = new TableColumn<>("");
		deleteCol.setCellValueFactory(param -> new ReadOnlyObjectWrapper<>(param.getValue()));
		deleteCol.setCellFactory(param -> new TableCell<OrderItem, OrderItem>() {
			private final Button deleteButton = new Button("Delete");

			@Override
			protected void updateItem(OrderItem orderItem, boolean empty) {
				super.updateItem(orderItem, empty);
				if (orderItem == null) {
					setGraphic(null);
					return;
				}
				setGraphic(deleteButton);
				deleteButton.setOnAction(event -> {
					double oldPrice = Double.parseDouble(orderItem.getPrice())
							* Integer.parseInt(orderItem.getQuantity());
					totalPrice.setText(String.valueOf(Double.parseDouble(totalPrice.getText()) - oldPrice));
					getTableView().getItems().remove(orderItem);
					newerData.remove(orderItem);
					try {
						String tableLabel = tableNumber.getText();
						String[] tableArray = tableLabel.split("Table: ");
						int tableNum = Integer.parseInt(tableArray[1]);
						String file = "";
						for (Order o : orders) {
							if (o.getTableNumber() == tableNum) {
								file = o.getFile();
							}
						}
						writeOrder(file);
					} catch (Exception e) {
						e.printStackTrace();
					}
				});
			}
		});
		for (OrderItem o : orderData) {
			newerData.add(o);
		}

		order.setItems(orderData);
		order.getColumns().addAll(orderItemCol, quantityCol, commentCol, priceCol, deleteCol);
		// System.out.println(order.getItems().size() + " " + orderData.size() +
		// " " + newData.size() + " " + importedData.size());
	}

	public void addItem(ActionEvent event) throws Exception {
		getItems();
		String tableLabel = tableNumber.getText();
		String[] tableArray = tableLabel.split("Table: ");
		int tableNum = Integer.parseInt(tableArray[1]);
		String file = "";
		for (Order o : orders) {
			if (o.getTableNumber() == tableNum) {
				file = o.getFile();
			}
		}
		try {
			BufferedReader in = new BufferedReader(new FileReader(file));
			String dataLine;
			newData.clear();
			newerData.clear();
			while ((dataLine = in.readLine()) != null) {
				for (int i = 0; i < 3; i += 4) {
					String[] dataValues = dataLine.split(",");
					newData.add(new OrderItem(dataValues[i], dataValues[i + 1], dataValues[i + 2], dataValues[i + 3]));
				}
			}
			in.close();
		} catch (Exception e) {
		} finally {
			populateOrder(newData);
		}
		String newItemString = (String) comboBoxItems.getSelectionModel().getSelectedItem();
		for (int i = 0; i < importedData.size(); i++) {
			if (importedData.get(i).getItem().equals(newItemString)) {
				itemIndex = i;
			}
		}
		orderItemIndex = -1;
		for (int i = 0; i < newerData.size(); i++) {
			if (newerData.get(i).getOrderItem().equals(newItemString)) {
				orderItemIndex = i;
			}
		}
		System.out.println(itemIndex + " " + orderItemIndex);
		if (orderItemIndex != -1) {
			if (commentBox.getText().equals("")) {
				OrderItem o = newerData.get(orderItemIndex);
				o.setQuantity(String.valueOf(Integer.parseInt(o.getQuantity()) + 1));
				Item newItem = importedData.get(itemIndex);
				double newPrice = Double.parseDouble(newItem.getPrice());
				totalPrice.setText(String.valueOf(Double.parseDouble(totalPrice.getText()) + newPrice));
			} else {
				Item newItem = importedData.get(itemIndex);
				double newPrice = Double.parseDouble(newItem.getPrice());
				totalPrice.setText(String.valueOf(Double.parseDouble(totalPrice.getText()) + newPrice));
				newerData.add(new OrderItem(newItem.getItem(), "1", commentBox.getText(), newItem.getPrice()));
				order.getItems().add(new OrderItem(newItem.getItem(), "1", commentBox.getText(), newItem.getPrice()));
			}
		} else {
			Item newItem = importedData.get(itemIndex);
			double newPrice = Double.parseDouble(newItem.getPrice());
			totalPrice.setText(String.valueOf(Double.parseDouble(totalPrice.getText()) + newPrice));
			newerData.add(new OrderItem(newItem.getItem(), "1", commentBox.getText(), newItem.getPrice()));
			order.getItems().add(new OrderItem(newItem.getItem(), "1", commentBox.getText(), newItem.getPrice()));
		}
		writeOrder(file);
	}

	public void writeOrder(String file) throws Exception {
		Writer writer = null;
		try {
			Files.delete(Paths.get(file));
			File f = new File(file);
			f.createNewFile();
			writer = new BufferedWriter(new FileWriter(f));
			for (OrderItem orderItem : newerData) {
				String text = orderItem.getOrderItem() + "," + orderItem.getQuantity() + "," + orderItem.getComment()
						+ "," + orderItem.getPrice() + "\n";
				writer.write(text);
			}
		} catch (Exception ex) {
			ex.printStackTrace();
		} finally {
			writer.flush();
			writer.close();
		}
	}
}
